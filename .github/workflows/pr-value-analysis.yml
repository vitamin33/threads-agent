name: PR Value Analysis

on:
  pull_request:
    types: [opened, edited, synchronize]
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number to analyze'
        required: true
        type: string

jobs:
  analyze-pr-value:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install GitHub CLI
      run: |
        curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo gpg --dearmor -o /usr/share/keyrings/githubcli-archive-keyring.gpg
        echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
        sudo apt update
        sudo apt install gh -y
    
    - name: Determine PR Number
      id: pr_number
      run: |
        if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
          echo "pr_number=${{ inputs.pr_number }}" >> $GITHUB_OUTPUT
        else
          echo "pr_number=${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
        fi
    
    - name: Run PR Value Analysis
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        python scripts/pr-value-analyzer.py ${{ steps.pr_number.outputs.pr_number }}
    
    - name: Upload Analysis Results
      uses: actions/upload-artifact@v4
      with:
        name: pr-value-analysis
        path: |
          pr_${{ steps.pr_number.outputs.pr_number }}_value_analysis.json
          .achievements/pr_${{ steps.pr_number.outputs.pr_number }}_achievement.json
    
    - name: Comment PR with Value Summary
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const fs = require('fs');
          const analysisFile = `pr_${{ steps.pr_number.outputs.pr_number }}_value_analysis.json`;
          
          try {
            const data = JSON.parse(fs.readFileSync(analysisFile, 'utf8'));
            
            // Build comment
            let comment = '## üìä Automated PR Value Analysis\n\n';
            
            // Business Metrics with explanations
            if (data.business_metrics && Object.keys(data.business_metrics).length > 0) {
              comment += '### üí∞ Business Value\n';
              
              // Add calculation transparency
              comment += '<details><summary>üìê How these metrics are calculated</summary>\n\n';
              comment += '- **Throughput Improvement**: `((current_rps / baseline_rps) - 1) √ó 100%`\n';
              comment += '- **Infrastructure Savings**: Based on RPS improvement reducing server needs\n';
              comment += '- **ROI**: `(annual_savings / development_cost) √ó 100%`\n';
              comment += '- **User Experience**: Score based on latency (<100ms = 10, <200ms = 9)\n';
              comment += '\n‚ö†Ô∏è **Note**: Baseline RPS assumed at 100. Actual baseline may vary.\n';
              comment += '</details>\n\n';
              
              for (const [key, value] of Object.entries(data.business_metrics)) {
                let displayValue = value;
                let explanation = '';
                
                // Add context for large percentages
                if (key === 'throughput_improvement_percent' && value > 200) {
                  explanation = ' ‚ö†Ô∏è *(May be inflated - verify baseline)*';
                }
                if (key === 'infrastructure_savings_estimate' && value > 50000) {
                  explanation = ' *(Based on estimated server reduction)*';
                }
                if (key === 'roi_year_one_percent') {
                  displayValue = `${value}%`;
                }
                
                comment += `- **${key.replace(/_/g, ' ')}**: ${displayValue}${explanation}\n`;
              }
              comment += '\n';
            }
            
            // Technical Metrics
            if (data.technical_metrics?.performance) {
              comment += '### üöÄ Performance Metrics\n';
              for (const [key, value] of Object.entries(data.technical_metrics.performance)) {
                comment += `- **${key.replace(/_/g, ' ')}**: ${value}\n`;
              }
              comment += '\n';
            }
            
            // KPIs
            if (data.kpis) {
              comment += '### üìà Key Performance Indicators\n';
              const overall = data.kpis.overall_score || 0;
              comment += `- **Overall Score**: ${overall}/10 `;
              
              if (overall >= 8) {
                comment += 'üåü Excellent!\n';
              } else if (overall >= 6) {
                comment += '‚úÖ Good\n';
              } else {
                comment += '‚ö†Ô∏è Needs Improvement\n';
              }
              
              for (const [key, value] of Object.entries(data.kpis)) {
                if (key !== 'overall_score') {
                  comment += `- **${key.replace(/_/g, ' ')}**: ${value}\n`;
                }
              }
              comment += '\n';
            }
            
            // Achievement Tags
            if (data.achievement_tags && data.achievement_tags.length > 0) {
              comment += '### üè∑Ô∏è Achievement Tags\n';
              comment += data.achievement_tags.map(tag => `\`${tag}\``).join(' ');
              comment += '\n\n';
            }
            
            // Future Impact
            if (data.future_impact && Object.keys(data.future_impact).length > 0) {
              comment += '### üîÆ Projected Impact\n';
              for (const [key, value] of Object.entries(data.future_impact)) {
                comment += `- **${key.replace(/_/g, ' ')}**: ${value}\n`;
              }
            }
            
            comment += '\n---\n';
            comment += '*This analysis was automatically generated by the PR Value Analyzer*';
            
            // Post comment
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ steps.pr_number.outputs.pr_number }},
              body: comment
            });
            
          } catch (error) {
            console.error('Error posting analysis comment:', error);
          }
    
    - name: Store Achievement Data
      if: success()
      run: |
        # This would typically push to a metrics database or achievement tracking system
        echo "Achievement data stored in artifacts"
    
    - name: Push to Achievement Collector
      if: success() && env.ACHIEVEMENT_COLLECTOR_URL != ''
      env:
        ACHIEVEMENT_COLLECTOR_URL: ${{ secrets.ACHIEVEMENT_COLLECTOR_URL }}
        ACHIEVEMENT_API_KEY: ${{ secrets.ACHIEVEMENT_API_KEY }}
      run: |
        # Call achievement collector API to create enriched achievement
        if [ -n "$ACHIEVEMENT_COLLECTOR_URL" ]; then
          curl -X POST \
            "${ACHIEVEMENT_COLLECTOR_URL}/pr-analysis/analyze/${{ steps.pr_number.outputs.pr_number }}" \
            -H "Authorization: Bearer ${ACHIEVEMENT_API_KEY}" \
            -H "Content-Type: application/json" \
            --fail-with-body \
            || echo "Failed to push to achievement collector (non-critical)"
        fi