# Revenue Service

Complete revenue infrastructure for Threads Agent Stack, enabling multiple monetization streams including affiliate marketing, lead capture, and subscription payments.

## Overview

The Revenue Service provides:

1. **Affiliate Link Management** - Contextual link injection with click/conversion tracking
2. **Lead Capture System** - Email capture with scoring and nurturing workflows  
3. **Stripe Payment Integration** - Subscription management for SaaS tiers
4. **Revenue Analytics** - Comprehensive reporting and forecasting

## Architecture

```
revenue/
├── main.py                 # FastAPI application
├── affiliate_manager.py    # Affiliate link injection and tracking
├── stripe_integration.py   # Stripe subscription management
├── lead_capture.py        # Lead capture and scoring
├── analytics.py           # Revenue analytics and reporting
├── db/
│   ├── models.py          # SQLAlchemy models
│   └── alembic/           # Database migrations
└── tests/                 # Comprehensive test suite
```

## API Endpoints

### Lead Capture
- `POST /revenue/capture-lead` - Capture lead with attribution
- `POST /revenue/lead/{email}/convert` - Mark lead as converted
- `GET /revenue/leads/export` - Export lead data

### Affiliate Management
- `POST /revenue/inject-affiliate-links` - Inject contextual links
- `POST /revenue/track-click` - Track affiliate click
- `POST /revenue/track-conversion` - Track affiliate conversion

### Subscriptions
- `POST /revenue/create-subscription` - Create Stripe subscription
- `DELETE /revenue/subscription/{id}` - Cancel subscription
- `POST /revenue/stripe-webhook` - Handle Stripe webhooks

### Analytics
- `GET /revenue/analytics` - Revenue summary
- `GET /revenue/affiliate-stats` - Affiliate performance
- `GET /revenue/lead-funnel` - Lead funnel metrics
- `GET /revenue/subscription-metrics` - Subscription metrics
- `GET /revenue/forecast` - Revenue forecast

## Configuration

### Environment Variables

```bash
# Database
DATABASE_URL=postgresql://user:pass@postgres:5432/threads_agent

# Stripe (required for payments)
STRIPE_API_KEY=sk_test_...
STRIPE_WEBHOOK_SECRET=whsec_...
STRIPE_PRICE_BASIC=price_...
STRIPE_PRICE_PRO=price_...
STRIPE_PRICE_ENTERPRISE=price_...

# Optional
REVENUE_SERVICE_URL=http://revenue:8080
```

### Helm Values

```yaml
revenue:
  enabled: true
  stripe:
    apiKey: "sk_test_..."
    webhookSecret: "whsec_..."
    priceBasic: "price_test_basic"
    pricePro: "price_test_pro"
    priceEnterprise: "price_test_enterprise"
  affiliateId: "viral123"
```

## Integration with Content Pipeline

The revenue service integrates seamlessly with the content generation pipeline:

1. Content is generated by persona-runtime
2. Quality gate ensures high-quality content
3. **Revenue enhancement** adds affiliate links and CTAs
4. Content is published with revenue tracking

### Example Integration

```python
# In celery_worker/main.py
from services.celery_worker.revenue_integration import enhance_content_with_revenue

# After content generation
revenue_result = enhance_content_with_revenue(
    content,
    persona_id,
    content_id,
    category
)
enhanced_content = revenue_result["enhanced_content"]
```

## Revenue Streams

### 1. Affiliate Commissions
- Contextual link placement based on content analysis
- Support for multiple affiliate networks
- Click and conversion tracking
- Commission reporting

### 2. Lead Generation  
- Email capture with validation
- Lead scoring based on engagement
- Automated nurturing sequences
- CRM export capabilities

### 3. Subscription Revenue
- Three tiers: Basic ($29), Pro ($97), Enterprise ($297)
- Stripe integration for payments
- Feature gating support
- Churn tracking and MRR calculation

## Metrics

The service exposes Prometheus metrics at `/metrics`:

- `affiliate_clicks_total` - Total affiliate clicks
- `affiliate_conversions_total` - Total conversions
- `affiliate_revenue_usd` - Affiliate revenue
- `leads_captured_total` - Total leads captured
- `lead_score_average` - Average lead score
- `subscriptions_created_total` - New subscriptions
- `mrr_usd` - Monthly Recurring Revenue
- `revenue_total_usd` - Total revenue by type

## Database Schema

### Tables
- `affiliate_links` - Affiliate link tracking
- `leads` - Lead information and scoring
- `revenue_events` - All revenue events
- `subscriptions` - Active subscriptions
- `customers` - Customer records

## Testing

Run the comprehensive test suite:

```bash
cd services/revenue
pytest tests/ -v
```

Test coverage includes:
- Affiliate link injection and tracking
- Lead capture and scoring
- Stripe payment flows
- Analytics calculations
- API endpoint testing

## Performance

- Revenue API responds in <100ms
- Affiliate link injection adds <50ms latency
- Analytics queries complete in <500ms
- Supports 100+ concurrent users

## Development

### Local Setup

```bash
# Install dependencies
pip install -r requirements.txt

# Run migrations
alembic upgrade head

# Start service
uvicorn services.revenue.main:app --reload
```

### Adding New Affiliate Merchants

Edit `affiliate_manager.py`:

```python
self.affiliate_db["category"]["merchant"] = AffiliateMerchant(
    name="merchant",
    base_url="https://merchant.com",
    ref_param="ref",
    category="category"
)
```

## Production Considerations

1. **Stripe Setup**
   - Create products and prices in Stripe dashboard
   - Set up webhook endpoint
   - Configure webhook secret

2. **Security**
   - Use production Stripe keys
   - Enable HTTPS for webhook endpoint
   - Implement rate limiting

3. **Scaling**
   - Add Redis for caching
   - Consider read replicas for analytics
   - Implement queue for webhook processing

## ROI Tracking

The service provides comprehensive ROI tracking:

1. **Content Attribution** - Track which content drives revenue
2. **Channel Performance** - Compare organic vs affiliate vs direct
3. **Customer LTV** - Calculate lifetime value by source
4. **Forecast Accuracy** - Compare projections to actuals