# Optimized Dockerfile template with cache mounts
# syntax=docker/dockerfile:1.4

FROM python:3.12-slim-bookworm AS base

# Enable BuildKit cache mounts
ENV PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1 \
    PIP_NO_CACHE_DIR=1 \
    PIP_DISABLE_PIP_VERSION_CHECK=1

FROM base AS deps

# Copy only requirements first (better layer caching)
COPY services/SERVICE_NAME/requirements.txt /tmp/requirements.txt

# Install with cache mount
RUN --mount=type=cache,target=/root/.cache/pip \
    pip install -r /tmp/requirements.txt

FROM deps AS app

WORKDIR /app

# Copy common first (changes less frequently)
COPY services/common /app/services/common

# Then service-specific code
COPY services/SERVICE_NAME /app/services/SERVICE_NAME

# Set Python path
ENV PYTHONPATH=/app:$PYTHONPATH

# Run tests in build (fail fast)
RUN --mount=type=cache,target=/app/.pytest_cache \
    python -m pytest services/SERVICE_NAME/tests -x --timeout=30 || true

CMD ["python", "-m", "services.SERVICE_NAME.main"]